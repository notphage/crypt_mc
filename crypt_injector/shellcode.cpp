#include "shellcode.hpp"
#include "maker.hpp"
#include "cast.hpp"

std::array<std::byte, shellcode::call_dllmain_entry_size> shellcode::call_dllmain_entry(std::uintptr_t image, std::uintptr_t dllmain) noexcept
{
	// dllmain_call_x64_entry.asm
	auto shellcode = maker::create_byte_array(
		0x48, 0x83, 0xEC, 0x28, 0x48, 0xB9,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x48, 0xC7, 0xC2, 0x01, 0x00, 0x00, 0x00,
		0x4D, 0x31, 0xC0, 0x48, 0xB8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xFF, 0xD0, 0x48, 0x83, 0xC4, 0x28, 0xC3
	);

	*cast::long_pointer(shellcode.data() + 0x6) = image;
	*cast::long_pointer(shellcode.data() + 0x1A) = dllmain;

	return shellcode;
}

std::array<std::byte, shellcode::hijack_dllmain_entry_size> shellcode::hijack_dllmain_entry(std::uintptr_t image, std::uintptr_t dllmain) noexcept
{
	// dllmain_hijack_x64.asm
	auto shellcode = maker::create_byte_array(0x9C, 0x50, 0x53, 0x51, 0x52, 0x55, 0x56, 0x57, 0x41, 0x50, 0x41, 0x51, 0x41, 0x52, 0x41, 0x53, 0x41, 0x54, 0x41, 0x55, 0x41, 0x56, 0x41, 0x57, 0x48, 0x81, 0xEC, 0x00, 0x01, 0x00, 0x00, 0x48, 0xB9, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x48, 0xC7, 0xC2, 0x01, 0x00, 0x00, 0x00, 0x4D, 0x31, 0xC0, 0x48, 0xB8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xD0, 0x48, 0x81, 0xC4, 0x00, 0x01, 0x00, 0x00, 0x41, 0x5F, 0x41, 0x5E, 0x41, 0x5D, 0x41, 0x5C, 0x41, 0x5B, 0x41, 0x5A, 0x41, 0x59, 0x41, 0x58, 0x5F, 0x5E, 0x5D, 0x5A, 0x59, 0x5B, 0x58, 0x9D, 0x48, 0xC7, 0x05, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0xC3, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90);
	
	constexpr auto shadowspace_size = 0x100;

	*cast::int_pointer(shellcode.data() + 0x1B) = shadowspace_size;

	*cast::long_pointer(shellcode.data() + 0x21) = image;
	*cast::long_pointer(shellcode.data() + 0x35) = dllmain;

	*cast::int_pointer(shellcode.data() + 0x42) = shadowspace_size;

	return shellcode;
}

std::array<std::byte, shellcode::call_dllmain_exit_size> shellcode::call_dllmain_exit(std::uintptr_t image, std::uintptr_t dllmain) noexcept
{
	// dllmain_call_x64_entry.asm
	auto shellcode = maker::create_byte_array(
		0x48, 0x83, 0xEC, 0x28, 0x48, 0xB9,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x48, 0xC7, 0xC2, 0x00, 0x00, 0x00, 0x00,
		0x4D, 0x31, 0xC0, 0x48, 0xB8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xFF, 0xD0, 0x48, 0x83, 0xC4, 0x28, 0xC3
	);

	*cast::long_pointer(shellcode.data() + 0x6) = image;
	*cast::long_pointer(shellcode.data() + 0x1A) = dllmain;

	return shellcode;
}

std::array<std::byte, shellcode::hijack_dllmain_exit_size> shellcode::hijack_dllmain_exit(std::uintptr_t image, std::uintptr_t dllmain) noexcept
{
	return std::array<std::byte, hijack_dllmain_exit_size>();
}
